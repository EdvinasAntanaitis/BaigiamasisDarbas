<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="#{worklog.title}">Work Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">

    <div th:if="${message}" class="alert alert-success" role="alert" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>

    <h2 class="mb-4" th:text="#{worklog.header}">Work Start / End</h2>

    <!-- Search + QR scanner -->
    <form th:action="@{/orders/worklog/search}" method="get" class="mb-3 d-flex align-items-center gap-2">
        <label for="orderId" class="me-2" th:text="#{worklog.search.label}">Search order by ID:</label>
        <input type="number" id="orderId" name="orderId" class="form-control" required style="max-width:140px;">
        <button type="submit" class="btn btn-primary" th:text="#{worklog.search.button}">Search</button>
        <button type="button" class="btn btn-secondary" onclick="openQrScanner()" th:text="#{worklog.qr.button}">Scan QR</button>
    </form>

    <!-- QR modal -->
    <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrModalLabel" th:text="#{worklog.qr.modal.title}">Scan QR code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="reader" style="width:100%"></div>
                    <div id="qrResult" class="mt-2 text-danger"></div>
                </div>
            </div>
        </div>
    </div>

    <p>
        <strong th:text="#{worklog.loggedin}">Logged in user:</strong>
        <span th:text="${#authentication?.principal?.firstName + ' ' + #authentication?.principal?.lastName}">User name</span>
    </p>

    <div th:if="${order != null}">
        <h4><span th:text="#{worklog.order}">Order:</span> <span th:text="${order.orderName}"></span></h4>
        <p><strong th:text="#{worklog.description}">Description:</strong> <span th:text="${order.description}"></span></p>
        <p>
            <strong th:text="#{worklog.paint.type}">Paint Type:</strong>
            <span th:text="${!order.partGroups.isEmpty()} ? ${order.partGroups[0].paintColor} : #{worklog.not.specified}">Not specified</span>
        </p>

        <h3 class="mt-4" th:text="#{worklog.performed.operations}">Performed operations / Ongoing tasks</h3>
        <table class="table table-bordered">
            <thead>
            <tr>
                <th th:text="#{worklog.worker}">Worker</th>
                <th th:text="#{worklog.date.time}">Date and Time</th>
                <th th:text="#{worklog.operation}">Operation</th>
                <th th:text="#{worklog.action}">Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="log : ${order.workLogs}">
                <td th:text="${log.workerName}">Worker Name</td>
                <td>
                    <span th:text="${#temporals.format(log.startTime, 'yyyy-MM-dd HH:mm')}"></span> -
                    <span th:if="${log.endTime != null}" th:text="${#temporals.format(log.endTime, 'yyyy-MM-dd HH:mm')}"></span>
                    <span th:unless="${log.endTime != null}">...</span>
                </td>
                <td th:text="${log.operationName}">Operation</td>
                <td>
                    <button type="button"
                            class="btn btn-danger btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#faultModal"
                            th:attr="data-worklog-id=${log.id}"
                            onclick="setWorkLogId(this)"
                            th:if="${log.endTime == null and !log.faulty}"
                            th:text="#{worklog.mark.faulty}">
                        Mark as Faulty
                    </button>
                    <form th:if="${log.faulty and !log.faultFixed}" method="post"
                          th:action="@{/orders/worklog/fix/{id}(id=${log.id})}"
                          style="display:inline">
                        <button type="submit" class="btn btn-secondary btn-sm" th:text="#{worklog.fix.fault}">Fix Fault</button>
                    </form>
                    <div th:if="${log.faulty and log.faultFixed}" class="badge bg-info text-dark mt-1" th:text="#{worklog.fault.fixed}">Fault fixed</div>
                    <form th:if="${log.endTime == null}"
                          th:unless="${log.faulty and !log.faultFixed}"
                          th:action="@{/orders/worklog/end}" method="post" style="display:inline;">
                        <input type="hidden" name="workLogId" th:value="${log.id}" />
                        <button type="submit" class="btn btn-warning btn-sm" th:text="#{worklog.end}">End</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="mt-4 d-flex gap-3">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#startWorkModal" th:text="#{worklog.start.work}">Start Work</button>
        </div>

        <form th:action="@{/orders/end}" method="post" th:if="${order != null}">
            <input type="hidden" name="orderId" th:value="${order.id}" />
            <button class="btn btn-success mt-3" th:text="#{worklog.end.order}">End Order</button>
        </form>

        <div class="mt-5">
            <h5 th:text="#{worklog.order.description}">Order Description</h5>
            <textarea class="form-control" rows="3" disabled th:text="${order.description}"></textarea>
        </div>
    </div>

    <a class="btn btn-primary mt-3" th:href="@{/dashboard}" th:text="#{worklog.back.dashboard}">Back to Dashboard</a>
</div>

<!-- Start Work Modal -->
<div class="modal fade" id="startWorkModal" tabindex="-1" aria-labelledby="startWorkLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" th:action="@{/orders/worklog/start}">
                <div class="modal-header">
                    <h5 class="modal-title" id="startWorkLabel" th:text="#{worklog.start.modal.title}">Select Operation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="orderId" th:value="${order?.id}" />
                    <select name="operation" class="form-select" required>
                        <option value="" th:text="#{worklog.start.modal.choose}">-- Choose operation --</option>
                        <option value="Sanding" th:text="#{worklog.start.modal.sanding}">Sanding</option>
                        <option value="Priming" th:text="#{worklog.start.modal.priming}">Priming</option>
                        <option value="Painting" th:text="#{worklog.start.modal.painting}">Painting</option>
                        <option value="Lacquering" th:text="#{worklog.start.modal.lacquering}">Lacquering</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success" th:text="#{worklog.start.modal.start}">Start</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Fault Modal -->
<div class="modal fade" id="faultModal" tabindex="-1" aria-labelledby="faultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/orders/worklog/fault}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="faultModalLabel" th:text="#{worklog.fault.modal.title}">Mark as Faulty</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="faultWorkLogId" name="workLogId"/>

                    <div class="mb-2">
                        <label th:text="#{worklog.fault.modal.operation.name}">Operation Name:</label>
                        <input type="text" id="faultOperationName" name="operationName" class="form-control" required />
                    </div>

                    <div class="mb-2">
                        <label th:text="#{worklog.fault.modal.fault.description}">Fault Description:</label>
                        <textarea id="faultDescription" name="faultDescription" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger" th:text="#{worklog.fault.modal.confirm}">Confirm Fault</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    function setWorkLogId(button) {
        const workLogId = button.getAttribute("data-worklog-id");
        document.getElementById("faultWorkLogId").value = workLogId;
        document.getElementById("faultOperationName").value = button.getAttribute("data-operation-name") || '';
        document.getElementById("faultDescription").value = button.getAttribute("data-fault-description") || '';
    }

    let qrScanner = null;
    function openQrScanner() {
        var qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
        qrModal.show();
        if (!qrScanner) {
            qrScanner = new Html5Qrcode("reader");
        }
        qrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
                qrScanner.stop();
                document.getElementById('reader').innerHTML = "";
                qrModal.hide();
                if (decodedText.startsWith('http')) {
                    window.location.href = decodedText;
                } else if (!isNaN(decodedText)) {
                    document.getElementById('orderId').value = decodedText;
                    document.querySelector('form').submit();
                } else {
                    document.getElementById('qrResult').textContent = /*[[#{worklog.qr.unrecognized}]]*/ "Unrecognized QR code";
                }
            },
            (errorMessage) => {}
        ).catch(err => {
            document.getElementById('qrResult').textContent = /*[[#{worklog.qr.camerafail}]]*/ "Could not start camera:" + err;
        });
    }
    document.getElementById('qrModal').addEventListener('hidden.bs.modal', function () {
        if (qrScanner) {
            qrScanner.stop();
            document.getElementById('reader').innerHTML = "";
        }
    });
</script>

</body>
</html>
