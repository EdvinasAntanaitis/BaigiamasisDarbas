<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="#{worklog.title}">Work Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">

    <div th:if="${message}" class="alert alert-success" role="alert" th:text="${message}"></div>
    <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>

    <h2 class="mb-4" th:text="#{worklog.header}">Work Start / End</h2>

    <form id="searchForm" th:action="@{/orders/worklog}" method="get" class="mb-3 d-flex align-items-center gap-2">
        <label for="orderId" class="me-2" th:text="#{worklog.search.label}">Search order by ID:</label>
        <input type="number" id="orderId" name="orderId" class="form-control" style="max-width:160px;" min="1">
        <button type="submit" class="btn btn-primary" th:text="#{worklog.search.button}">Search</button>
        <button type="button" class="btn btn-secondary" onclick="openQrScanner()" th:text="#{worklog.qr.button}">Scan QR</button>
    </form>

    <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="qrModalLabel" th:text="#{worklog.qr.modal.title}">Scan QR code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="reader" style="width:100%"></div>
                    <div id="qrResult" class="mt-2 text-danger"></div>
                </div>
            </div>
        </div>
    </div>

    <p class="text-muted">
        <strong th:text="#{worklog.loggedin}">Logged in user:</strong>
        <span th:text="${#authentication?.principal?.firstName + ' ' + #authentication?.principal?.lastName}">User name</span>
    </p>

    <div th:if="${order == null}" class="alert alert-info">
        <span th:text="#{worklog.empty.state}">Enter Order ID or scan QR to see work log.</span>
    </div>

    <div th:if="${order != null}">
        <h4 class="mb-1">
            <span th:text="#{worklog.order}">Order:</span>
            <span th:text="${order.orderName}">—</span>
            <small class="text-muted">(ID: <span th:text="${order.id}">0</span>)</small>
        </h4>

        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <strong th:text="#{worklog.description}">Description:</strong>
                <div th:text="${order.description}">—</div>
            </div>
            <div class="col-md-4">
                <strong th:text="#{worklog.material}">Material:</strong>
                <span th:if="${order.partGroups != null and !order.partGroups.isEmpty()}" th:text="${order.partGroups.get(0).material}">—</span>
                <span th:unless="${order.partGroups != null and !order.partGroups.isEmpty()}" th:text="#{worklog.not.specified}">Not specified</span>
            </div>
            <div class="col-md-4">
                <strong th:text="#{worklog.paint.type}">Paint Type:</strong>
                <span th:if="${order.partGroups != null and !order.partGroups.isEmpty()}" th:text="${order.partGroups.get(0).paintColor}">—</span>
                <span th:unless="${order.partGroups != null and !order.partGroups.isEmpty()}" th:text="#{worklog.not.specified}">Not specified</span>
            </div>
        </div>

        <h3 class="mt-4 mb-3" th:text="#{worklog.performed.operations}">Performed operations / Ongoing tasks</h3>

        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                <tr>
                    <th th:text="#{worklog.worker}">Worker</th>
                    <th th:text="#{worklog.date.time}">Date and Time</th>
                    <th th:text="#{worklog.operation}">Operation</th>
                    <th th:text="#{worklog.status}">Status</th>
                    <th th:text="#{worklog.action}">Action</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="log : ${worklogs}">
                    <td th:text="${log.workerName}">Worker Name</td>
                    <td>
                        <span th:text="${#temporals.format(log.startTime, 'yyyy-MM-dd HH:mm')}">2025-01-01 10:00</span>
                        <span> - </span>
                        <span th:if="${log.endTime != null}" th:text="${#temporals.format(log.endTime, 'yyyy-MM-dd HH:mm')}"></span>
                        <span th:unless="${log.endTime != null}">…</span>
                    </td>
                    <td th:text="${log.operationName}">Operation</td>
                    <td>
                        <span th:if="${log.faulty and !log.faultFixed}" class="badge bg-danger" th:text="#{worklog.status.faulty}">Faulty</span>
                        <span th:if="${log.faulty and log.faultFixed}" class="badge bg-info text-dark" th:text="#{worklog.fault.fixed}">Fault fixed</span>
                        <span th:if="${!log.faulty and log.endTime == null}" class="badge bg-warning text-dark" th:text="#{worklog.status.inprogress}">In progress</span>
                        <span th:if="${!log.faulty and log.endTime != null}" class="badge bg-success" th:text="#{worklog.status.done}">Done</span>
                    </td>
                    <td class="d-flex gap-2 flex-wrap">
                        <button type="button"
                                class="btn btn-danger btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#faultModal"
                                th:attr="data-worklog-id=${log.id},data-operation-name=${log.operationName}"
                                th:if="${log.endTime == null and !log.faulty}"
                                onclick="setWorkLogId(this)"
                                th:text="#{worklog.mark.faulty}">
                            Mark as Faulty
                        </button>

                        <form th:if="${log.faulty and !log.faultFixed}" th:action="@{/orders/worklog/fix/{id}(id=${log.id})}" method="post" class="d-inline">
                            <input type="hidden" name="orderId" th:value="${order.id}"/>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-secondary btn-sm" th:text="#{worklog.fix.fault}">Fix Fault</button>
                        </form>

                        <form th:if="${log.endTime == null and !(log.faulty and !log.faultFixed)}" th:action="@{/orders/worklog/end}" method="post" class="d-inline">
                            <input type="hidden" name="workLogId" th:value="${log.id}"/>
                            <input type="hidden" name="orderId" th:value="${order.id}"/>
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-warning btn-sm" th:text="#{worklog.end}">End</button>
                        </form>
                    </td>
                </tr>
                <tr th:if="${worklogs == null or #lists.isEmpty(worklogs)}">
                    <td colspan="5" class="text-center text-muted" th:text="#{worklog.no.entries}">No entries yet.</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-4 d-flex gap-3">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#startWorkModal" th:text="#{worklog.start.work}">Start Work</button>
        </div>

        <form class="mt-3" th:action="@{/orders/end}" method="post">
            <input type="hidden" name="orderId" th:value="${order.id}"/>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button class="btn btn-success" th:text="#{worklog.end.order}">End Order</button>
        </form>

        <div class="mt-4">
            <h5 th:text="#{worklog.order.description}">Order Description</h5>
            <textarea class="form-control" rows="3" disabled th:text="${order.description}"></textarea>
        </div>
    </div>

    <a class="btn btn-primary mt-4" th:href="@{/dashboard}" th:text="#{worklog.back.dashboard}">Back to Dashboard</a>
</div>

<div class="modal fade" id="startWorkModal" tabindex="-1" aria-labelledby="startWorkLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" th:action="@{/orders/worklog/start}">
                <div class="modal-header">
                    <h5 class="modal-title" id="startWorkLabel" th:text="#{worklog.start.modal.title}">Select Operation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="orderId" th:value="${order?.id}"/>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <select name="operation" class="form-select" required>
                        <option value="" th:text="#{worklog.start.modal.choose}">-- Choose operation --</option>
                        <option value="Sanding" th:text="#{worklog.start.modal.sanding}">Sanding</option>
                        <option value="Priming" th:text="#{worklog.start.modal.priming}">Priming</option>
                        <option value="Painting" th:text="#{worklog.start.modal.painting}">Painting</option>
                        <option value="Lacquering" th:text="#{worklog.start.modal.lacquering}">Lacquering</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success" th:text="#{worklog.start.modal.start}">Start</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="faultModal" tabindex="-1" aria-labelledby="faultModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/orders/worklog/fault}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="faultModalLabel" th:text="#{worklog.fault.modal.title}">Mark as Faulty</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="faultWorkLogId" name="workLogId"/>
                    <input type="hidden" name="orderId" th:value="${order?.id}"/>
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="mb-2">
                        <label class="form-label" th:text="#{worklog.fault.modal.operation.name}">Operation Name:</label>
                        <input type="text" id="faultOperationName" name="operationName" class="form-control" required/>
                    </div>
                    <div class="mb-2">
                        <label class="form-label" th:text="#{worklog.fault.modal.fault.description}">Fault Description:</label>
                        <textarea id="faultDescription" name="faultDescription" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger" th:text="#{worklog.fault.modal.confirm}">Confirm Fault</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:if="${error}" class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Cannot Complete Order</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0" th:text="${error} ">Can't complete this order. Some tasks are still in progress or there are unresolved faults.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script th:inline="javascript">
    function setWorkLogId(button) {
        const id = button.getAttribute("data-worklog-id");
        const op = button.getAttribute("data-operation-name") || '';
        document.getElementById("faultWorkLogId").value = id;
        document.getElementById("faultOperationName").value = op;
        document.getElementById("faultDescription").value = '';
    }

    let qrScanner = null;
    function openQrScanner() {
        const qrModalEl = document.getElementById('qrModal');
        const qrModal = new bootstrap.Modal(qrModalEl);
        qrModal.show();

        if (!qrScanner) qrScanner = new Html5Qrcode("reader");
        qrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: 250 },
            (decodedText) => {
                qrScanner.stop().then(() => {
                    document.getElementById('reader').innerHTML = "";
                    qrModal.hide();
                });
                if (decodedText.startsWith('http')) { window.location.href = decodedText; return; }
                if (!isNaN(decodedText)) {
                    document.getElementById('orderId').value = decodedText;
                    document.getElementById('searchForm').submit();
                    return;
                }
                document.getElementById('qrResult').textContent = "Unrecognized QR code";
            },
            () => {}
        ).catch(err => {
            document.getElementById('qrResult').textContent = "Could not start camera: " + err;
        });

        qrModalEl.addEventListener('hidden.bs.modal', function () {
            if (qrScanner) {
                qrScanner.stop().finally(() => { document.getElementById('reader').innerHTML = ""; });
            }
        }, { once: true });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const hasError = false;
        if (hasError) {
            const m = new bootstrap.Modal(document.getElementById('errorModal'));
            m.show();
        }
    });
</script>
</body>
</html>
