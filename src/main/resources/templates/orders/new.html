<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="#{order.new.title}">Create New Order</title>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4" th:text="#{order.new.title}">Create New Order</h1>

    <form th:action="@{/orders/new}" th:object="${orderForm}" method="post" class="needs-validation" novalidate>
        <div class="mb-3">
            <label class="form-label" th:text="#{order.new.name}">Order Name:</label>
            <input type="text" th:field="*{orderName}" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label" th:text="#{order.new.description}">Description:</label>
            <textarea th:field="*{description}" class="form-control" rows="4"></textarea>
        </div>

        <div id="groupsContainer"></div>

        <div class="mt-3 mb-4">
            <strong th:text="#{order.new.total.area}">Total Order Area (m²):</strong> <span id="totalOrderArea">0.000</span>
        </div>

        <button type="button" onclick="addGroup()" class="btn btn-outline-primary mb-3" th:text="#{order.new.add.material}">+ Add Material & Color Group</button>
        <br>
        <button type="submit" class="btn btn-success" th:text="#{order.new.create.order}">Create Order</button>
        <a th:href="@{/dashboard}" class="btn btn-secondary ms-2" th:text="#{order.new.dashboard}">Back to Dashboard</a>
    </form>
</div>

<script>
    let groupIndex = 0;

    function addGroup() {
        const container = document.getElementById('groupsContainer');
        const groupDiv = document.createElement('div');
        groupDiv.classList.add('card', 'mb-4', 'p-3');
        const currentIndex = groupIndex;

        groupDiv.innerHTML = `
            <h5 class="mb-3">Group ${currentIndex + 1}</h5>
            <div class="mb-3">
                <label th:text="#{order.new.material}">Material:</label>
                <input type="text" name="partGroups[${currentIndex}].material" class="form-control" required>
            </div>
            <div class="mb-3">
                <label  th:text="#{order.new.paint.color}">Paint Color:</label>
                <input type="text" name="partGroups[${currentIndex}].paintColor" class="form-control" required>
            </div>

            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th th:text="#{order.new.length}">Length (mm)</th>
                        <th th:text="#{order.new.width}">Width (mm)</th>
                        <th th:text="#{order.new.thickness}">Thickness (mm)</th>
                        <th th:text="#{order.new.amount}">Amount</th>
                        <th th:text="#{order.new.painted.area}">Painted Area</th>
                        <th th:text="#{order.new.area}">Area (m²)</th>
                        <th th:text="#{order.new.action}">Action</th>
                    </tr>
                </thead>
                <tbody id="group-${currentIndex}-parts"></tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" class="text-end"><strong th:text="#{order.new.group.area}">Group Area (m²):</strong></td>
                        <td id="group-${currentIndex}-area">0.000</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>

            <button type="button" onclick="addPartRow(${currentIndex})" class="btn btn-outline-secondary" th:text="#{order.new.add.part}">+ Add Part</button>
        `;

        container.appendChild(groupDiv);
        groupIndex++;
    }

    function addPartRow(groupIdx) {
        const tbody = document.getElementById(`group-${groupIdx}-parts`);
        const index = tbody.rows.length;
        const row = tbody.insertRow();

        row.innerHTML = `
            <td><input type="number" name="partGroups[${groupIdx}].parts[${index}].length" class="form-control length" required oninput="calculateAllAreas()"></td>
            <td><input type="number" name="partGroups[${groupIdx}].parts[${index}].width" class="form-control width" required oninput="calculateAllAreas()"></td>
            <td><input type="number" name="partGroups[${groupIdx}].parts[${index}].thickness" class="form-control thickness" required oninput="calculateAllAreas()"></td>
            <td><input type="number" name="partGroups[${groupIdx}].parts[${index}].amount" class="form-control amount" value="1" min="1" required oninput="calculateAllAreas()"></td>
            <td>
                <select name="partGroups[${groupIdx}].parts[${index}].paintedArea" class="form-select painted" onchange="calculateAllAreas()">
                    <option value="ALL_SIDES" th:text="#{order.new.full.detail}">Full detail (default)</option>
                    <option value="ONE_EDGE" th:text="#{order.new.one.edge}">One edge</option>
                    <option value="TWO_EDGES" th:text="#{order.new.two.edge}">Two edges</option>
                    <option value="THREE_EDGES" th:text="#{order.new.three.edge}">Three edges</option>
                    <option value="ONE_SIDE_NO_EDGES" th:text="#{order.new.one.side.without.edges}">One side without edges</option>
                    <option value="ONE_SIDE_WITH_EDGES" th:text="#{order.new.one.side.with.edges}">One side with edges</option>
                </select>
            </td>
            <td class="area">0.000</td>
            <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this); calculateAllAreas()" th:text="#{order.new.remove}">Remove</button></td>
        `;
    }

    function calculateAllAreas() {
        let totalOrderArea = 0;

        for (let g = 0; g < groupIndex; g++) {
            const rows = document.querySelectorAll(`#group-${g}-parts tr`);
            let groupArea = 0;

            rows.forEach(row => {
                const length = parseFloat(row.querySelector(".length")?.value) || 0;
                const width = parseFloat(row.querySelector(".width")?.value) || 0;
                const thickness = parseFloat(row.querySelector(".thickness")?.value) || 0;
                const amount = parseInt(row.querySelector(".amount")?.value) || 1;
                const painted = row.querySelector(".painted")?.value;
                const areaCell = row.querySelector(".area");

                let areaPerPiece = 0;
                switch (painted) {
                    case "ONE_EDGE": areaPerPiece = width * thickness; break;
                    case "TWO_EDGES": areaPerPiece = 2 * width * thickness; break;
                    case "THREE_EDGES": areaPerPiece = 2 * width * thickness + length * thickness; break;
                    case "ONE_SIDE_NO_EDGES": areaPerPiece = length * width; break;
                    case "ONE_SIDE_WITH_EDGES":
                        areaPerPiece = length * width + 2 * (length * thickness + width * thickness);
                        break;
                    default:
                        areaPerPiece = 2 * (length * width + length * thickness + width * thickness);
                }

                const totalRowArea = (areaPerPiece * amount) / 1_000_000;
                areaCell.textContent = totalRowArea.toFixed(3);
                groupArea += totalRowArea;
            });

            document.getElementById(`group-${g}-area`).textContent = groupArea.toFixed(3);
            totalOrderArea += groupArea;
        }

        document.getElementById("totalOrderArea").textContent = totalOrderArea.toFixed(3);
    }

    function removeRow(button) {
        button.closest('tr').remove();
    }
</script>

</body>
</html>
